<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ServiExpres | Chatea con Adrian</title>

  <!-- Fuente -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">

  <!-- n8n Chat CSS -->
  <link href="https://cdn.jsdelivr.net/npm/@n8n/chat/dist/style.css" rel="stylesheet" />

  <style>
    :root { --azul:#0057B8; --azul-sec:#00AEEF; --blanco:#ffffff; --gris:#eef2f7; }
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%;width:100%;font-family:'Inter',sans-serif;background:#16213e;color:var(--blanco)}
    body{min-height:100vh;min-width:100vw;position:relative}

    #lines-bg-canvas{position:fixed;inset:0;width:100vw;height:100vh;z-index:0;pointer-events:none}
    .overlay{background:rgba(10,30,60,0.82);min-height:100vh;display:flex;flex-direction:column;align-items:center;padding-bottom:4rem;position:relative;z-index:1}

    header{width:100%;max-width:900px;text-align:center;margin-top:3rem;padding:0 1rem}
    header h1{font-size:2.6rem;font-weight:700;margin-bottom:.4rem}
    header p{font-size:1.05rem;opacity:.95;margin-bottom:1rem}

    .top-botones{display:flex;gap:1rem;justify-content:center;flex-wrap:wrap;margin-bottom:2rem}
    .top-botones a{display:inline-flex;align-items:center;gap:.5rem;background:var(--blanco);color:var(--azul);padding:.55rem 1rem;border-radius:999px;font-weight:600;text-decoration:none;border:2px solid var(--azul);box-shadow:0 3px 14px rgba(0,0,0,0.08)}
    .top-botones a:hover{background:var(--azul-sec);color:#fff}

    .contenido{width:100%;max-width:900px;background:rgba(255,255,255,0.06);border-radius:18px;padding:2rem;margin-bottom:2.4rem;box-shadow:0 6px 30px rgba(0,0,0,0.18);display:flex;flex-direction:column;align-items:center}
    .contenido h2{color:var(--azul-sec);font-size:1.8rem;margin-bottom:.8rem}
    .contenido p{line-height:1.6;margin-bottom:1rem;color:rgba(255,255,255,0.95)}
    .contenido ul{list-style:none;padding:0;max-width:640px;text-align:left;font-size:1.02rem}
    .contenido li{padding-left:1.6rem;margin-bottom:.65rem;position:relative}
    .contenido li::before{content:"‚úÖ";position:absolute;left:0}

    footer{width:100%;text-align:center;color:var(--gris);font-size:.95rem;margin-bottom:1rem}

    /* Widget mobile fix */
    .n8n-chat__footer,.n8n-chat__input,.n8n-chat__send{display:block!important;opacity:1!important}
    @media(max-width:600px){ .n8n-chat__footer{position:fixed!important;bottom:0;width:100vw;z-index:999999;background:#fff} .n8n-chat__input{font-size:1.05rem!important} }

    /* Estado visible */
    #chat-status{display:none;position:fixed;left:50%;transform:translateX(-50%);top:1rem;z-index:999999;background:#fff4c2;color:#6a4b00;padding:.8rem 1rem;border-radius:8px;box-shadow:0 8px 30px rgba(0,0,0,0.18);max-width:calc(100% - 2rem);font-size:.95rem;line-height:1.2}
    /* Mensajes de error (rojo) */
    #chat-error{display:none;position:fixed;left:50%;transform:translateX(-50%);top:4.5rem;z-index:999999;background:#ffe6e6;color:#6a0000;padding:.8rem 1rem;border-radius:8px;box-shadow:0 8px 30px rgba(0,0,0,0.18);max-width:calc(100% - 2rem);font-size:.95rem;line-height:1.2}
  </style>
</head>
<body>
  <div id="chat-status" role="status" aria-live="polite"></div>
  <div id="chat-error" role="alert"></div>

  <canvas id="lines-bg-canvas"></canvas>

  <div class="overlay">
    <header>
      <h1>ServiExpres</h1>
      <p>Transformamos procesos t√©cnicos en soluciones digitales inteligentes</p>

      <div class="top-botones" aria-hidden="false">
        <a href="https://wa.me/573232864625" target="_blank" rel="noopener">üì± WhatsApp</a>
        <a href="https://www.instagram.com/finazas_organizadas/" target="_blank" rel="noopener">üì∏ Instagram</a>
        <a href="mailto:Gerencia@serviexpres.co">‚úâÔ∏è Correo</a>
      </div>
    </header>

    <main class="contenido" role="main">
      <h2>¬øQui√©n soy?</h2>
      <p>Soy Adri√°n, un apasionado por la automatizaci√≥n, infraestructura web y dise√±o estrat√©gico. Combino creatividad con precisi√≥n t√©cnica para ayudar a que los negocios digitales avancen con impacto y profesionalismo.</p>

      <h2>Lo que hago</h2>
      <ul>
        <li>Automatizaci√≥n con n8n y Docker</li>
        <li>Configuraci√≥n profesional de dominios, DNS y GitHub Pages</li>
        <li>Integraci√≥n de WhatsApp, Instagram y chatbots personalizados</li>
        <li>Dise√±o de landing pages efectivas con HTML y CSS</li>
        <li>Campa√±as de productos digitales como plantillas financieras</li>
      </ul>
    </main>

    <footer>¬© 2025 ServiExpres | Desarrollo web & Automatizaci√≥n inteligente</footer>
  </div>

  <script>
    // Fondo animado (l√≠neas)
    const canvas = document.getElementById('lines-bg-canvas');
    const ctx = canvas.getContext('2d');
    let w = window.innerWidth, h = window.innerHeight;
    function resize(){ w = window.innerWidth; h = window.innerHeight; canvas.width = w; canvas.height = h; }
    window.addEventListener('resize', resize);
    resize();
    const POINTS = 45, SPEED = 0.16, DIST = 140;
    const nodes = [];
    function rand(a,b){ return a + Math.random()*(b-a); }
    for(let i=0;i<POINTS;i++) nodes.push({ x: rand(0,w), y: rand(0,h), vx: rand(-SPEED,SPEED), vy: rand(-SPEED,SPEED) });
    function animate(){
      ctx.clearRect(0,0,w,h);
      for(let i=0;i<POINTS;i++){
        for(let j=i+1;j<POINTS;j++){
          const a = nodes[i], b = nodes[j];
          const dx = a.x - b.x, dy = a.y - b.y, d = Math.hypot(dx,dy);
          if(d < DIST){ ctx.save(); ctx.globalAlpha = 1 - d / DIST; ctx.strokeStyle = '#00AEEF'; ctx.lineWidth = 1.1; ctx.beginPath(); ctx.moveTo(a.x,a.y); ctx.lineTo(b.x,b.y); ctx.stroke(); ctx.restore(); }
        }
      }
      for(let i=0;i<POINTS;i++){
        const n = nodes[i];
        ctx.save(); ctx.globalAlpha = 0.65; ctx.beginPath(); ctx.arc(n.x,n.y,2.7,0,Math.PI*2); ctx.fillStyle = '#00AEEF'; ctx.shadowColor = '#00AEEF'; ctx.shadowBlur = 8; ctx.fill(); ctx.restore();
        n.x += n.vx; n.y += n.vy;
        if(n.x < 0 || n.x > w) n.vx = -n.vx;
        if(n.y < 0 || n.y > h) n.vy = -n.vy;
      }
      requestAnimationFrame(animate);
    }
    animate();
  </script>

  <script type="module">
    import { createChat } from 'https://cdn.jsdelivr.net/npm/@n8n/chat/dist/chat.bundle.es.js';

    // ---------- CONFIG ----------
    // URL p√∫blica de tu webhook en n8n (confirmada por ti)
    const webhookUrl = 'https://myn8ndesplegadoenservidor-adddbbbyb5dgbvdc.mexicocentral-01.azurewebsites.net/webhook/8c38e2c0-3ddc-4acc-ac2b-5b1dc603f538/chat';

    // Si quieres usar un proxy en tu propio dominio (recomendado si
    // sigues teniendo problemas CORS), p.ej. /api/n8n-proxy
    // deja en blanco para no usar proxy:
    const proxyUrl = ''; // Ej: '/api/n8n-proxy'  <- si lo configuras en tu servidor

    // ---------- UI helpers ----------
    const statusEl = document.getElementById('chat-status');
    const errorEl = document.getElementById('chat-error');
    function showStatus(msg){ statusEl.innerHTML = msg; statusEl.style.display = 'block'; }
    function hideStatus(){ statusEl.style.display = 'none'; }
    function showError(msg){ errorEl.innerHTML = msg; errorEl.style.display = 'block'; }
    function hideError(){ errorEl.style.display = 'none'; }

    // Comprueba si un fetch OPTIONS responde correctamente con CORS
    async function checkOptions(url){
      try {
        const res = await fetch(url, { method: 'OPTIONS', mode: 'cors' });
        console.log('OPTIONS status:', res.status, res.statusText, res.headers);
        return res;
      } catch (err) {
        console.warn('OPTIONS check failed:', err);
        return null;
      }
    }

    (async () => {
      hideStatus(); hideError();

      // Evitar mixed content (si la p√°gina est√° en https, el webhook debe ser https)
      if (location.protocol === 'https:' && webhookUrl.startsWith('http:')) {
        showError('<strong>ERROR:</strong> el webhook usa HTTP, pero la p√°gina est√° en HTTPS. Usa la URL p√∫blica HTTPS de tu n8n.');
        return;
      }

      showStatus('Verificando webhook y CORS...');

      // 1) Intento de OPTIONS directo a n8n
      const opts = await checkOptions(webhookUrl);

      if (opts && (opts.status >= 200 && opts.status < 400)) {
        // Si OPTIONS responde bien (200/204), proceed
        hideStatus();
      } else {
        // OPTIONS fall√≥ o devolvi√≥ 404 ‚Äî intentamos fallback:
        console.warn('La comprobaci√≥n OPTIONS no devolvi√≥ 2xx/3xx. Respuesta:', opts);
        // 2) Si el usuario tiene proxy configurado en el cliente, usarlo (misma origen)
        if (proxyUrl) {
          showStatus('Usando proxy en el mismo origen para evitar CORS...');
        } else {
          showStatus('No se pudo verificar CORS. Si el chat no responde correctamente, crea un proxy en tu propio dominio (recomendado) o habilita CORS en Azure App Service para tu n8n.');
        }
      }

      // Decide qu√© URL pasar al widget: si definiste proxyUrl la usamos, sino la webhookUrl
      const webhookToUse = (proxyUrl && proxyUrl.trim().length > 0) ? proxyUrl.trim() : webhookUrl;

      // Instrucciones si detectamos que OPTIONS devuelve 404: damos mensajes √∫tiles
      if (!opts || !(opts.status >= 200 && opts.status < 400)) {
        // Si no hay proxy y OPTIONS falla, mostramos instrucciones √∫tiles.
        if (!proxyUrl) {
          showError(`<strong>Atenci√≥n - CORS:</strong> tu servidor n8n respondi√≥ <code>OPTIONS 404</code> o no respondi√≥ al preflight. 
            El widget n8n realiza solicitudes que requieren que el servidor permita CORS (respondiendo con <code>Access-Control-Allow-Origin</code>).
            Soluciones posibles:
            <ul>
              <li>Habilitar CORS en Azure App Service: Configuraci√≥n ‚Üí CORS ‚Üí agregar <code>https://serviexpres.co</code> y reiniciar la App.</li>
              <li>Establecer variables de entorno en n8n (y reiniciar): <code>N8N_ENDPOINT_WEBHOOK_ALLOW_CORS=true</code> y/o <code>N8N_DEFAULT_HEADERS</code> con los <code>Access-Control-Allow-*</code>.</li>
              <li>Crear un endpoint proxy en tu dominio (recomendado si no puedes cambiar n8n): ver ejemplo abajo.</li>
            </ul>
            Si quieres, te doy el ejemplo de proxy listo para poner en tu servidor (Node/Express).`);
        } else {
          // Usuario tiene proxy definido; el widget usar√° proxyToUse por lo que puede evitar CORS.
          hideError();
          hideStatus();
        }
      }

      // Inicializa el widget n8n Chat con la URL seleccionada (webhookToUse).
      try {
        createChat({
          webhookUrl: webhookToUse,
          botName: 'Adrian',
          language: 'es',
          title: 'Chatea con Adrian ü§ñ',
          description: '¬°Hola! Soy Adrian. ¬øEn qu√© puedo ayudarte hoy?',
          inputPlaceholder: 'Escribe tu mensaje...',
          mobile: { alwaysShowInput: true }
        });
        console.log('n8n Chat widget inicializado con webhook:', webhookToUse);

        // Si usamos el webhook directo (sin proxy) y OPTIONS fall√≥, avisamos en consola:
        if (webhookToUse === webhookUrl && (!opts || !(opts.status >= 200 && opts.status < 400))) {
          console.warn('Advertencia: el servidor n8n no respondi√≥ OK a OPTIONS. Es posible que el chat falle al enviar mensajes si el servidor no permite CORS.');
        }
      } catch (err) {
        console.error('Error inicializando createChat:', err);
        showError('No se pudo inicializar el chat. Revisa la consola para m√°s detalles.');
      }
    })();
  </script>

  <!--
    ---------- OPCIONAL: ejemplo de proxy Node.js (Express) ----------
    Si no puedes lograr que n8n responda con Access-Control-Allow-Origin,
    despliega este proxy en tu propio dominio (p.e. https://serviexpres.co/api/n8n-proxy)
    y luego pon `const proxyUrl = '/api/n8n-proxy';` arriba.

    // Ejemplo (server.js):
    const express = require('express');
    const fetch = require('node-fetch'); // o native fetch en Node 18+
    const app = express();
    app.use(express.json());
    const TARGET = 'https://myn8ndesplegadoenservidor-adddbbbyb5dgbvdc.mexicocentral-01.azurewebsites.net';
    const WEBHOOK_PATH = '/webhook/8c38e2c0-3ddc-4acc-ac2b-5b1dc603f538/chat';

    app.options('/api/n8n-proxy', (req, res) => {
      res.header('Access-Control-Allow-Origin', 'https://serviexpres.co');
      res.header('Access-Control-Allow-Methods', 'GET,POST,OPTIONS');
      res.header('Access-Control-Allow-Headers', 'Content-Type');
      return res.sendStatus(204);
    });

    app.post('/api/n8n-proxy', async (req, res) => {
      try {
        const r = await fetch(TARGET + WEBHOOK_PATH, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(req.body)
        });
        const text = await r.text();
        res.status(r.status).send(text);
      } catch (err) {
        console.error('proxy error', err);
        res.status(500).send('proxy error');
      }
    });

    app.listen(3000, () => console.log('proxy running'));

    Luego en HTML: const proxyUrl = '/api/n8n-proxy';
  -->

</body>
</html>
