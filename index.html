<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ServiExpres | Chatea con Adrian</title>
  <!-- n8n Chat CSS -->
  <link href="https://cdn.jsdelivr.net/npm/@n8n/chat/dist/style.css" rel="stylesheet" />
  <style>
    :root{
      --bg: #16213e;
      --card: rgba(255,255,255,0.07);
      --accent: #00AEEF;
      --white: #fff;
      --muted: rgba(255,255,255,0.88);
      --warn-bg: #fff4c2;
      --warn-text: #6a4b00;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%;width:100%;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--white)}
    .wrap{max-width:1100px;margin:28px auto;padding:16px}
    header{text-align:center;margin-bottom:18px}
    header h1{font-size:1.6rem;margin-bottom:6px}
    .grid{display:grid;grid-template-columns:1fr 420px;gap:18px}
    .card{background:var(--card);border-radius:14px;padding:18px;box-shadow:0 10px 30px rgba(0,0,0,0.25)}
    .muted{color:var(--muted);line-height:1.6}
    ul.simple{margin-top:12px;padding-left:18px}
    footer{text-align:center;margin-top:18px;color:rgba(255,255,255,0.7)}
    /* chat area container - widget appends UI globally, but keep area for UX */
    .chat-area{min-height:360px;border-radius:12px;overflow:hidden;display:flex;align-items:flex-end;justify-content:center;padding:12px}
    /* status / warning box */
    #statusBox{display:none;position:fixed;left:50%;transform:translateX(-50%);top:12px;z-index:99999;background:var(--warn-bg);color:var(--warn-text);padding:10px 14px;border-radius:8px;box-shadow:0 8px 30px rgba(0,0,0,0.18);max-width:calc(100% - 32px);font-size:0.95rem;line-height:1.2}
    /* mobile */
    @media (max-width:900px){
      .grid{grid-template-columns:1fr}
    }
    /* Make widget input visible on mobile */
    .n8n-chat__footer, .n8n-chat__input, .n8n-chat__send { display:block !important; opacity:1 !important; }
    @media(max-width:600px){
      .n8n-chat__footer{position:fixed !important;bottom:0;width:100vw;z-index:999999;background:#fff}
      .n8n-chat__input{font-size:1.05rem !important}
    }
  </style>
</head>
<body>
  <div id="statusBox" role="status" aria-live="polite"></div>
  <div class="wrap">
    <header>
      <h1>Chatea con Adrian ü§ñ</h1>
      <div class="muted">Soporte y automatizaci√≥n ‚Äî disponible 24/7</div>
    </header>
    <div class="grid">
      <div class="card">
        <h2 style="color:var(--accent);margin-bottom:8px">Hola ‚Äî soy Adrian</h2>
        <p class="muted">Usa este chat para hacer preguntas sobre automatizaciones, dominios, integraciones y m√°s. Si el chat no aparece inmediatamente, mira el mensaje arriba (preflight/CORS).</p>
        <ul class="simple">
          <li>Automatizaci√≥n con n8n y flujos personalizados</li>
          <li>Configuraci√≥n de dominios y despliegues</li>
          <li>Integraciones con WhatsApp, Instagram y APIs</li>
        </ul>
        <div style="margin-top:12px;color:var(--muted);font-size:0.95rem">
          Nota: si ves un error "No 'Access-Control-Allow-Origin' header" debes habilitar CORS en el endpoint o usar un proxy HTTPS que agregue esa cabecera.
        </div>
      </div>
      <aside id="chatArea" class="card chat-area" aria-label="Chat con Adrian">
        <!-- widget inyecta su UI (se mostrar√° sobre la p√°gina) -->
        <div style="text-align:center;color:var(--muted)">El chat aparecer√° aqu√≠ si el webhook es accesible.</div>
      </aside>
    </div>
    <footer>
      ¬© 2025 ServiExpres | Desarrollo web &amp; Automatizaci√≥n inteligente
    </footer>
  </div>
  <script type="module">
    import { createChat } from 'https://cdn.jsdelivr.net/npm/@n8n/chat/dist/chat.bundle.es.js';
    // ----------------- CONFIGURA AQU√ç -----------------
    // Webhook p√∫blico en Render (tu n8n)
    const directWebhook = 'https://n8n-tx1r.onrender.com/webhook/29d89778-b129-4332-a8d8-4f3473a4516e/chat';
    // Aseg√∫rate de habilitar CORS en el endpoint del webhook (Access-Control-Allow-Origin: *) para que funcione el chat.
    // Si despliegas el proxy (proxy.js) en Render, pega aqu√≠ la URL p√∫blica completa del proxy, por ejemplo:
    // const proxyUrl = 'https://mi-proxy.onrender.com/chat-proxy';
    // Si no tienes proxy, deja proxyUrl = '' (vac√≠o) y el script solamente notificar√° el error CORS.
    const proxyUrl = ''; // <-- Pega la URL de tu proxy aqu√≠ si la tienes.
    // --------------------------------------------------
    const statusBox = document.getElementById('statusBox');
    function showStatus(html){
      statusBox.innerHTML = html;
      statusBox.style.display = 'block';
    }
    function hideStatus(){
      statusBox.style.display = 'none';
    }
    // Comprueba si la URL responde y si incluye cabecera CORS necesaria
    async function checkCors(url){
      try {
        const res = await fetch(url, { method: 'OPTIONS' });
        // Si el servidor responde con un 2xx/3xx y la cabecera Access-Control-Allow-Origin existe, consideramos OK.
        const acao = res.headers.get('access-control-allow-origin');
        if (res.status >= 200 && res.status < 400 && acao) return { ok: true, acao };
        // si responde sin cabecera CORS devolveremos info
        return { ok: false, status: res.status, acao: acao };
      } catch (err) {
        // Error de red / CORS bloqueado -> no accesible desde navegador
        return { ok: false, error: err && err.message ? err.message : String(err) };
      }
    }
    (async () => {
      // 1) Evitar mixed content si la p√°gina est√° en HTTPS
      if (location.protocol === 'https:' && directWebhook.startsWith('http:')) {
        showStatus('<strong>ERROR:</strong> la URL del webhook usa HTTP mientras la p√°gina est√° en HTTPS. Usa la URL p√∫blica HTTPS de n8n o un proxy HTTPS.');
        console.error('Mixed content: webhook is http while page is https');
        return;
      }
      // 2) Intentar comprobar CORS en el webhook directo
      showStatus('Comprobando disponibilidad del webhook en n8n...');
      const check = await checkCors(directWebhook);
      if (check.ok) {
        // Directo OK: inicializar widget apuntando al webhook directo
        hideStatus();
        try {
          createChat({
            webhookUrl: directWebhook,
            botName: 'Adrian',
            language: 'es',
            title: 'Chatea con Adrian ü§ñ',
            description: '¬°Hola! Soy Adrian. ¬øEn qu√© puedo ayudarte hoy?',
            inputPlaceholder: 'Escribe tu mensaje...',
            mobile: { alwaysShowInput: true }
          });
          console.log('Widget inicializado con webhook directo:', directWebhook);
        } catch (err) {
          console.error('Error al inicializar createChat (directo):', err);
          showStatus('Error al inicializar el chat con el webhook directo. Mira la consola para detalles.');
        }
        return;
      }
      // 3) Si el check falla: mostrar motivo y, si hay proxy, intentar con √©l
      console.warn('Comprobaci√≥n CORS fallida:', check);
      if (proxyUrl && proxyUrl.trim().length > 0) {
        showStatus('No se detect√≥ cabecera CORS en el webhook. Reintentando usando el proxy configurado...');
        // Si proxy existe, comprobamos proxy y luego inicializamos apuntando al proxy
        try {
          const pcheck = await checkCors(proxyUrl);
          if (pcheck.ok) {
            hideStatus();
            try {
              createChat({
                webhookUrl: proxyUrl,
                botName: 'Adrian',
                language: 'es',
                title: 'Chatea con Adrian ü§ñ',
                description: '¬°Hola! Soy Adrian. ¬øEn qu√© puedo ayudarte hoy?',
                inputPlaceholder: 'Escribe tu mensaje...',
                mobile: { alwaysShowInput: true }
              });
              console.log('Widget inicializado con proxy:', proxyUrl);
              return;
            } catch (err) {
              console.error('Error inicializando createChat con proxy:', err);
              showStatus('No se pudo inicializar el chat con el proxy. Revisa la consola.');
              return;
            }
          } else {
            console.warn('Proxy comprobaci√≥n fallida:', pcheck);
            showStatus('El proxy no respondi√≥ correctamente o tampoco incluye CORS. Revisa tu proxy o habilita CORS en n8n.');
            return;
          }
        } catch (err) {
          console.error('Error comprobando el proxy:', err);
          showStatus('Error comprobando el proxy. Revisa la consola para m√°s detalles.');
          return;
        }
      }
      // 4) Si no hay proxy o no funciona, informamos paso a paso c√≥mo arreglar (en p√°gina)
      let message = '<strong>Aviso:</strong> no se pudo verificar el webhook desde este navegador. ';
      message += 'La causa m√°s com√∫n es que la respuesta del webhook no incluye la cabecera <code>Access-Control-Allow-Origin</code> (CORS). ';
      message += 'Soluciones recomendadas:<ol style="margin:.4rem 0 0 1rem;padding:0"><li>Habilitar CORS en el servidor/proxy que expone el webhook (a√±adir <code>Access-Control-Allow-Origin: *</code> o tu dominio).</li><li>Desplegar el proxy que reenv√≠e al webhook y a√±ada las cabeceras CORS (te puedo dar el c√≥digo del proxy si quieres).</li><li>Para pruebas locales usa ngrok para exponer n8n con HTTPS y pega la URL p√∫blica en el webhookUrl.</li></ol>';
      showStatus(message);
      console.error('CORS preflight failed. Detalles:', check);
    })();
  </script>
</body>
</html>
